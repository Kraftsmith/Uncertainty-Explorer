<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnose Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="../common-styles.css">
    <style>
        /* Page-specific styles for Summary */
        /* All specific styles for summary.html are now in common-styles.css */
        /* Or should be if they are truly page-specific and not covered by common rules */
        /* For example, if .export-btn has a unique color only on this page: */
        .export-btn {
            background-color: #4CAF50; /* Example of a page-specific override */
        }

        @media (max-width: 768px) {
            .chart-container, .cynefin-chart-container {
                height: 350px;
            }
        }
        @media (max-width: 480px) {
            .chart-container, .cynefin-chart-container {
                height: 300px;
            }
             .legend {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="left-nav-placeholder"></div>
    <div class="main-content-with-nav">
        <div class="section">
            <h1 class="section-title">Diagnose Summary</h1>


            <h3 class="section-title">Stacey Matrix Assessment Results</h3>
            <!-- Placeholder for the StaceyChartComponent -->
            <div id="stacey-chart-component-summary-placeholder"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color simple-color"></div>
                    <span>Simple (0-2.5)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color complicated-color"></div>
                    <span>Complicated (2.5-5)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color complex-color"></div>
                    <span>Complex (5-8)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color chaotic-color"></div>
                    <span>Chaotic (8-10)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color score-color"></div>
                    <span>Your Score</span>
                </div>
            </div>
            
            <!-- Placeholder for the Stacey Summary Component -->
            <div id="stacey-summary-component-placeholder"></div>
   
            <h3 class="section-title">Cynefin Framework Assessment Results</h3>
            
            <div class="cynefin-chart-container"> <!-- Removed ID as it might not be needed if chart is not dynamically manipulated here -->
                <div id="complex" class="quadrant">
                    <span class="quadrant-name">Complex</span>
                    <div class="domain-label" style="top: 45%;">Unknown Unknowns</div>
                    <div class="domain-approach" style="top: 60%;">
                        PROBE → SENSE → RESPOND<br>Emergent Practice
                    </div>
                </div>
                <div id="complicated" class="quadrant">
                    <span class="quadrant-name">Complicated</span>
                    <div class="domain-label" style="top: 45%;">Known Unknowns</div>
                    <div class="domain-approach" style="top: 60%;">
                        SENSE → ANALYSE → RESPOND<br>Good Practice
                    </div>
                </div>
                <div id="chaotic" class="quadrant">
                    <span class="quadrant-name">Chaotic</span>
                    <div class="domain-label" style="top: 45%;">Cause and Effect Unclear</div>
                    <div class="domain-approach" style="top: 60%;">
                        ACT → SENSE → RESPOND<br>Novel Practice
                    </div>
                </div>
                <div id="clear" class="quadrant">
                    <span class="quadrant-name">Clear</span>
                    <div class="domain-label" style="top: 45%;">Known Knowns</div>
                    <div class="domain-approach" style="top: 60%;">
                        SENSE → CATEGORISE → RESPOND<br>Best Practice
                    </div>
                </div>
                <div id="disorder" class="quadrant"><span class="quadrant-name">Disorder</span></div>
            </div>
            
            <div class="summary-section">
                         <div class="summary-card">
                    <h4>Current Domain</h4>
                    <div class="score-display">
                        <strong>Domain:</strong> <span id="current-domain">-</span>
                    </div>
                </div>
                <div class="summary-card">
                    <h4>Decision Making Score</h4>
                    <div class="score-display">
                        <strong>Score:</strong> <span id="decision-score">0.0</span>/10
                    </div>
                </div>
                
                <div class="summary-card">
                    <h4>Cause-and-Effect Score</h4>
                    <div class="score-display">
                        <strong>Score:</strong> <span id="cause-effect-score">0.0</span>/10
                    </div>
                </div>
                

            </div>
            
            <div class="domain-info" id="domain-info-display" style="display: none;">
                <h3 id="domain-title"></h3>
                <p><strong>Characteristics:</strong></p>
                <ul id="domain-characteristics"></ul>
                <p id="domain-approach-text"></p>
                <svg width="268" height="283" viewBox="0 0 268 283" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="268" height="283" fill="white"/>
                <!-- SVG content removed for brevity in diff, it remains unchanged -->
                </svg>
                <p><strong>Detailed Approach</strong></p>
                <ul id="domain-steps"></ul>
                <div id="delivery-practices-section" style="display: none;">
                     <h4>Delivery Framework</h4>
                     <table class="data-table"> <!-- Added class for potential specific styling -->
                        <thead>
                            <tr>
                                <th>Practice</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="delivery-practices-table-body">
                            <!-- Practices will be inserted here by JavaScript -->
                        </tbody>
                     </table>
                </div>
            </div>
        </div>
    </div>
      <script src="../JavaScript/assessment-utils.js"></script>
      <!-- <script src="cynefin-data.js"></script>  No longer needed if all data is in JSON -->
      <script src="../JavaScript/stacey-chart-component.js"></script>
      <script src="../JavaScript/stacey-summary-component.js"></script>
      <script>
        // Initialize chart variables
        // let staceyChart; // Will be managed by StaceyChartComponent
        let resultsDescriptionsData = null; // To store fetched JSON data

        // Load data and initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStaceySummaryComponent('stacey-summary-component-placeholder'); // Load the summary cards
            fetchResultsDescriptions(); // Fetch descriptions first
        });

        async function fetchResultsDescriptions() {
            try {
                const response = await fetch('../Data/results-descriptions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                resultsDescriptionsData = await response.json();
                loadData(); // Now that descriptions are loaded, proceed to load assessment data
            } catch (error) {
                console.error("Could not load results descriptions:", error);
                // Optionally display an error to the user
            }
        }

        // Load data from local storage and update displays
        function loadData() {
            const staceyDataFromStorage = assessmentUtils.loadFromLocalStorage('staceyMatrixResults');
            let staceyArea = null;
            let staceyComponentInstance = null;

            // Prepare options for StaceyChartComponent
            const staceyChartOptions = {
                parentElementId: 'stacey-chart-component-summary-placeholder', // New parent
                // canvasId: 'staceyChart', // Component can generate its own canvas ID or use this
                productScoreDisplayId: 'product-score',
                technicalScoreDisplayId: 'technical-score',
                teamScoreDisplayId: 'team-score', // This ID exists in summary.html
                areaDisplayId: 'area-result',
                areaNameDisplayId: 'area-name',
                // The above IDs for scores/area are for elements *outside* the chart component's direct rendering,
                // in the summary cards. The component updates them.
                isInteractive: false // Display only
            };

            if (staceyDataFromStorage) {
                // Apply team score adjustment if needed
                let productScore = staceyDataFromStorage.product.average;
                let technicalScore = staceyDataFromStorage.technical.average;
                
                if (staceyDataFromStorage.team.average > 5) {
                    const adjustment = Math.floor(staceyDataFromStorage.team.average - 5) * 0.5;
                    productScore += adjustment;
                    technicalScore += adjustment;
                    productScore = Math.min(productScore, 10);
                    technicalScore = Math.min(technicalScore, 10);
                }

                staceyArea = staceyDataFromStorage.area;

                staceyChartOptions.initialData = {
                    productScore: productScore,
                    technicalScore: technicalScore,
                    teamScore: staceyDataFromStorage.team.average,
                    area: staceyArea
                };
            }

            // Instantiate StaceyChartComponent
            staceyComponentInstance = new StaceyChartComponent(staceyChartOptions);

            // Load Cynefin Data (Key for Cynefin in Cynefin.html is 'cynefinFrameworkAssessmentResults_v3')
            // The key used in summary.html's original loadData was 'cynefinAssessmentResults'
            // Let's assume the key from Cynefin.html is the correct one to use for loading.
            const cynefinData = assessmentUtils.loadFromLocalStorage('cynefinFrameworkAssessmentResults_v3');
            if (cynefinData) {
                // The structure of cynefinData from Cynefin.html is different:
                // { allQuestionScores, domain, averageDecisionScore, averageCauseEffectScore, timestamp }
                document.getElementById('decision-score').textContent = cynefinData.averageDecisionScore.toFixed(1);
                document.getElementById('cause-effect-score').textContent = cynefinData.averageCauseEffectScore.toFixed(1);
                document.getElementById('current-domain').textContent = cynefinData.domain;
                
                highlightCurrentDomain(cynefinData.domain);
                updateDomainInfo(cynefinData.domain, staceyArea);
            }
        }

        // Highlight the current Cynefin domain
        function highlightCurrentDomain(domain) {
            document.querySelectorAll('.quadrant').forEach(quad => {
                quad.classList.remove('highlighted'); // Ensure this class is defined in CSS
            });
            
            const disorderElement = document.getElementById('disorder');
            if (domain.toLowerCase() !== "disorder") { // Ensure case-insensitivity for "Disorder"
                if (disorderElement) disorderElement.style.display = 'none';
                const domainElement = document.getElementById(domain.toLowerCase());
                if (domainElement) {
                    domainElement.classList.add('highlighted');
                }
            } else {
                if (disorderElement) {
                    disorderElement.classList.add('highlighted');
                    disorderElement.style.display = 'flex'; 
                }
            }
        }

        // Update Cynefin domain information display
        function updateDomainInfo(cynefinDomain, staceyArea) {
            const infoElement = document.getElementById('domain-info-display');
            const domainTitleEl = document.getElementById('domain-title');
            const characteristicsListEl = document.getElementById('domain-characteristics');
            const domainApproachEl = document.getElementById('domain-approach-text'); 
            const stepsListEl = document.getElementById('domain-steps');
            const deliveryPracticesSectionEl = document.getElementById('delivery-practices-section');
            const deliveryPracticesTableBodyEl = document.getElementById('delivery-practices-table-body');
            // Clear previous content
            domainTitleEl.textContent = '';
            characteristicsListEl.innerHTML = '';
            domainApproachEl.textContent = '';
            stepsListEl.innerHTML = '';
            deliveryPracticesTableBodyEl.innerHTML = ''; 
            deliveryPracticesSectionEl.style.display = 'none'; 

            if (!resultsDescriptionsData) {
                console.error("Results descriptions data not loaded.");
                infoElement.style.display = 'none';
                return;
            }

            let dataToDisplay = null;
            const cDomainLower = cynefinDomain.toLowerCase();
            const sAreaLower = staceyArea ? staceyArea.toLowerCase() : null;

            // Check for combined scenarios first
            if (sAreaLower && resultsDescriptionsData.combined[`${cDomainLower}_${sAreaLower}`]) {
                dataToDisplay = resultsDescriptionsData.combined[`${cDomainLower}_${sAreaLower}`];
            } else if (resultsDescriptionsData.cynefin[cDomainLower]) {
                // Fallback to just Cynefin domain data
                dataToDisplay = resultsDescriptionsData.cynefin[cDomainLower];
            }

            if (dataToDisplay) {
                domainTitleEl.textContent = dataToDisplay.title || `${dataToDisplay.name}${dataToDisplay.subtitle ? ` (${dataToDisplay.subtitle})` : ''}`;
                
                (dataToDisplay.characteristics || []).forEach(char => {
                    const li = document.createElement('li');
                    li.textContent = char;
                    characteristicsListEl.appendChild(li);
                });
                
                domainApproachEl.textContent = dataToDisplay.approach || '';
                
                (dataToDisplay.steps || []).forEach(stepText => {
                    const li = document.createElement('li');
                    li.textContent = stepText;
                    stepsListEl.appendChild(li);
                });

                if (dataToDisplay.deliveryPractices && dataToDisplay.deliveryPractices.length > 0) {
                    dataToDisplay.deliveryPractices.forEach(practiceName => {
                        const tr = document.createElement('tr');
                        
                        const practiceTd = document.createElement('td');
                        practiceTd.textContent = practiceName; // Assuming practiceName is a string
                        tr.appendChild(practiceTd);
                        
                        const descriptionTd = document.createElement('td');
                        // If practiceName were an object like {name: "...", description: "..."}
                        // descriptionTd.textContent = practiceName.description || "N/A";
                        descriptionTd.textContent = "N/A"; // Placeholder for now
                        tr.appendChild(descriptionTd);
                        
                        deliveryPracticesTableBodyEl.appendChild(tr);
                    });
                    deliveryPracticesSectionEl.style.display = 'block';
                }
                infoElement.style.display = 'block';
            } else { 
                infoElement.style.display = 'none';
                console.warn(`No data found for Cynefin domain: ${cynefinDomain} or combined scenario.`);
            }
        }

        // Add these new functions at the end of your script section
        function exportToPDF() {
            // Hide export buttons before generating PDF
            const exportButtons = document.querySelector('.export-buttons');
            exportButtons.style.display = 'none';

            const element = document.body;
            const opt = {
                margin: 1,
                filename: 'diagnose-summary.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Generate PDF
            html2pdf().set(opt).from(element).save().then(() => {
                // Show export buttons again after PDF is generated
                exportButtons.style.display = 'flex';
            });
        }

        function showEmailForm() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('emailForm').style.display = 'block';
        }

        function hideEmailForm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('emailForm').style.display = 'none';
        }

        function sendEmail() {
            const emailTo = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;

            if (!emailTo) {
                alert('Please enter a recipient email address');
                return;
            }

            // Hide export buttons before generating PDF
            const exportButtons = document.querySelector('.export-buttons');
            exportButtons.style.display = 'none';

            const element = document.body;
            const opt = {
                margin: 1,
                filename: 'diagnose-summary.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Generate PDF and send email
            html2pdf().set(opt).from(element).outputPdf('blob').then(pdfBlob => {
                // Create form data
                const formData = new FormData();
                formData.append('email', emailTo);
                formData.append('subject', subject);
                formData.append('message', message);
                formData.append('pdf', pdfBlob, 'diagnose-summary.pdf');

                // Send to server endpoint
                fetch('/api/send-email', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Email sent successfully!');
                        hideEmailForm();
                    } else {
                        alert('Failed to send email: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to send email. Please try again.');
                })
                .finally(() => {
                    // Show export buttons again
                    exportButtons.style.display = 'flex';
                });
            });
        }
    </script>
    <script src="../JavaScript/navigation-component.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => loadNavigationComponent('left-nav-placeholder'));
    </script>
    <div class="overlay" id="overlay"></div>
    <div class="email-form" id="emailForm">
        <h3>Send Summary via Email</h3>
        <input type="email" id="emailTo" placeholder="Recipient Email" required>
        <input type="text" id="emailSubject" placeholder="Subject" value="Diagnose Summary Report">
        <textarea id="emailMessage" placeholder="Message (optional)" rows="4"></textarea>
        <div style="text-align: right;">
            <button onclick="hideEmailForm()" class="cancel">Cancel</button>
            <button onclick="sendEmail()">Send</button>
        </div>
    </div>
</body>
</html>
